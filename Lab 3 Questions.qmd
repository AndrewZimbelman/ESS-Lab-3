---
title: "ESS Lab 3"
format: html
editor: visual
---

##Question 1:```
library(tidyverse); library(flextable)
data = read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv')
covid_data = data

##Question 2:
text = date("2021-02-01")
my.date <- as.Date(text)
class(my.date)
my.state= "Colorado"
Colorado_data = covid_data |>
  filter(state == my.state)|>
  group_by(county)|>
  arrange(date)|>
  mutate(new_cases = cases - lag(cases))|>
  mutate(new_deaths = deaths - lag(deaths))|>
  ungroup()
Colorado_data|>
  filter(date == my.date)|>
  slice_max(cases, n=5) |>
  select(Date = date, County = county, Cases = cases) |>
  flextable() |>
  set_caption("Most Total Cases")
View(Cumulative_Colorado_cases)
Colorado_data|>
  filter(date == my.date)|>
  slice_max(new_cases, n=5) |>
  select(Date = date, County = county, Cases = new_cases) |>
  flextable() |>
  set_caption("Most New Cases")
pop_data = read_csv('https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/totals/co-est2023-alldata.csv')
##Question 3: 

sprintf("%02s", (pop_data$STATE) , "%03s", (pop_data$COUNTY))

  fip_code = paste(pop_data$STATE, pop_data$COUNTY, sel =" ")
pop_data |>
  mutate(FIP = fip_code)
pop_data = pop_data |>
  filter(COUNTY > '000')
POP_data = pop_data |>
  select(contains('NAME'), contains('2021')) |>
  mutate(fip = paste0(pop_data$STATE,pop_data$COUNTY, sel = ""))
names(POP_data)
dim(POP_data)
#2. some of the common names are STNAME, CTYNAME, DEATHS2021, with 3144 rows & 19 columns 
#3. The range is from 741 to 737287 which is a total range of 736546
CO_POP_data = POP_data |>
  filter(STNAME == 'Colorado')
max(CO_POP_data$POPESTIMATE2021)
min(CO_POP_data$POPESTIMATE2021)
POP_data = POP_data|>
  rename('fips' = 'fip')
#range = 737287 - 741 = 736546
Covid_Population_Data = inner_join(POP_data,Colorado_data, by = 'fips')
new_data = joined_data |>
  group_by(date)|>
  select(date = date, County = county, Cases = cases, Population = POPESTIMATE2021, Deaths = deaths, New_Cases = new_cases, New_Deaths = new_deaths)|>
  na.omit(New_cases , New_Deaths)|>
  mutate(Per_capita_cum = (Cases/Population))|>
  mutate(Per_capita_new_case = (New_Cases/Population))|>
  mutate(Per_capita_new_deaths = (New_Deaths / Population))

flex_table_new <-new_data|>
  filter(date == my.date)|>
  select(date,County,Per_capita_cum)|>
  slice_max(Per_capita_cum, n = 5)|>
  flextable::flextable()|>
   flextable::set_caption('5 Highest Cumulative Covid Cases Per Capita in Colorado Counties')
flex_table <- set_header_labels(flex_table, date = "Date",
                    Per_capita_cum = "Cumulative Population")

new_flex_table <- new_data|>
  filter(date == my.date)|>
  select(date,County,Per_capita_new_case)|>
  slice_max(Per_capita_new_case, n = 5)|>
  flextable::flextable()|>
  flextable::set_caption('5 Highest Counties for New Covid Cases Per Capita in Colorado')
new_flex_table <- set_header_labels(new_flex_table, date = "Date",
                                    Per_capita_new_case = "New Cases                                      Per Capita")
new_flex_table
view(new_flex_table)
new_flex_table

##Question 4 
```{r}

  start_date = as.Date(2022-05-13)
  end_date = as.Date(2022-04-30)
 Watchlist_flextable = Covid_Population_Data|>
    filter(date >= (max(date - 14)))|>
    select(county,date,new_cases,POPESTIMATE2021)|>
    group_by(county)|>
    mutate(POPESTIMATE2021 = (sum(POPESTIMATE2021)/14)/100000)|>
    summarise(new_cases = sum((new_cases)/POPESTIMATE2021))|>
    slice_max(new_cases, n= 5) |>
    flextable::flextable() |>
    flextable::set_caption('Watch List Covid Counties')
 Watchlist_flextable <- set_header_labels(Watchlist_flextable, county = 'County', new_cases = 'New Cases')
```
##Question 5 
```{r}
  Covid_Population_Data|>
    date = as.date(2022-02-01)
```

